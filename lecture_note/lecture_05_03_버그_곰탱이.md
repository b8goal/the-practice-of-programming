# 5.3  실마리가 없는 어려운 버그

- 무엇이 잘못된 건지 전혀 알 수가 없다면 인생은 계속 꼬이기만 한다. by 책

## 버그를 재현할 수 있게 하라

- 첫 단계는 자유자재로 버그를 드러내도록 하는 일.
    
    - 시간을 할애해서 버그를 재현하는 기능을 만들어 이 버그로 부터 추후에 발생할 심각한 버그를 방지하자.
    - 버그를 재현하지 못하면 왜 못하는지, 조건을 찾아본다. 그러면 멍하니 재발생을 기다리는 시간을 줄일수 있다.
    - 디버깅이 가능한 프로그램을 사용한다. 시드값 같이 디버깅용 정보를 생성해서 결과를 재현 가능해야 한다.

## 각개격파 하라

- 문제를 발생시키는 입력의 범위를 줄인다. (디바이드 앤 컨쿼)
- 에러에만 집중한 주요 테스트 케이스를 찾아 각 테스트 케이스가 무엇이 잘못된 것인지에 대한 증명을 해서 명확한 결과를 내도록 설계 한다.
- 이진 탐색 방식을 이용해서 입력의 반을 날리는 식으로 버그가 관련된 입력을 찾는다.
- 취소 기능이 있는 에디터를 쓰면 버그를 남긴 채로 큰 테스트 케이스를 줄일 수 있다.

## 수가 의미하는 바를 연구하라

- 책의 저자들이 소스코드를 추가하면서 오타가 발생한 것을 확인했다.
- 오타들의 간격이 1023바이트 였고 1024바이트의 버퍼의 끝에 널이 씌워진 버그인걸 확인.
- 따라서 버그를 찾을땐 문제와 관련된 숫자의 패턴도 있다.

## 결과를 출력해서 탐색 범위를 좁혀라.
- 프로그램이 이해가 안되면 중간중간 출력문을 써서 파악하는것도 좋은 방법이다.
- 예를 들어 코드의 특정부분에 출력문을 작성하고 위로 타고 올라가면서 잘못된 것이 있는지 확인하는 방법이 있다.
- 간결한 형식으로 출력해 grep 함수로 패턴이나 값을 찾아 탐색하기 쉽게 해야 한다.
- 변수의 값을 출력할 때 같은 방식으로 출력해서 파악하기 쉽도록 한다.

## 자가검증 코드를 작성하라
- 더 많은 정보가 필요하다면 조건을 테스트하고 관련된 변수값을 출력한 다음에 프로그램을 중단시키는 check 함수를 직접 작성한다.

```c++
void check(char *s)
{
    if(var1>var2){
        printf("%s: var1 %d var2 %d \n",s,var1,var2);
        fflush(stdout);
        abort();
    }
}
```
- 이 함수는 abort를 호출하며 디버거 분석 작업을 할수 있도록 프로그램을 비정상 종료를 시킨다. 

```c++
check("before suspect");
/*  수상한코드*/
check("after suspect");
```
- 버그를 수정해도 해당 코드를 삭제하기 보단 주석으로 남겨둬서 디버깅 옵션으로 만들면 추후에 사용할때 편리.
- check 를 더 발전시켜 데이터 구조까지 출력하고 검증하는 작업을 일반화 하면, 데이터 구조나 다른 정보들의 일관성을 계속 검증하는 루틴이 된다.
- 복잡한 데이터 구조를 포함한 프로그램이라면 문제가 발생하기 전에 이러한 check를 활용해서 문제를 초기에 막을수 있다.

## 로그 파일을 작성하라

- 다른 전략은 디버깅용 고정 형식 스트림 출력을 담는 로그 파일을 작성하는 것이다.
- 프로그램이 죽으면 죽기 직전에 로그 파일을 기록한다.
- printf와 같은 함수는 종료 전에 버퍼가 버려지므로 fflush를 사용하여 출력을 모두 내보낸다.
- c+와 java에는 flush 함수가 있다.
- 프로그램에 부하를 감수할 경우 로그파일 r/w 시 버퍼링을 하지 않게해 버퍼 비우기로 인한 문제를 방지 가능.

## 그림을 그려라

- 테스트를 하고 디버깅을 할때 때론 글보다 그림이 효과적이다.
- 산점도(scatter plots)를 그리면 숫자를 나열한 것보다 훨씬 효과적으로 이상값을 표현 할 수 있다.
- 데이터 히스토그램은 시험 결과 난수 메모리 할당 루틴과 해시 테이블, 내부 버킷 크기 등의 이상 징후를 나타낸다.
- 프로그램 내부에서 무슨 일이 일어나는지 이해가 되지 않으면 데이터 구조에 통계를 적용해서 결과를 그래프로 그리면 된다.

## 도구를 사용하라

- 디버깅 환경이 제공하는 도구들을 잘 이용한다. 
- diff 같은 파일 비교 프로그램은 디버깅 결과와 잘못된 결과를 비교하여 바뀐 부분에 집중할수 있게 한다.
- 만약 출력이 같다면 grep을 써서 비교한다.
- 디버깅용 출력을 프린터로 보내기보다 셀 스크립트나 다른 도구를 활용해서 디버깅용 코드를 실행할때 나오는 출력을 처리를 자동화 한다.
- 가정한 내용이나 자신이 이해한 내용을 확인하기 위해 단순한 프로그램을 작성한다.
```c++
// 다음과 같이 NULL 포인터를 해제해도 괜찮을까?
int main(void){
    free(NULL);
    return 0;
}
```
- RCS와 같은 소스코드 제어 프로그램을 사용하면 코드를 버전 별로 추적 기록해서 수정 내용이나 복구가 가능하다.

## 기록하라
- 버그를 찾으면서 시간이 흐르면 어떤 시도를 했는지 어떤걸 깨닳았는지 잊어버리기 시작한다.
- 이를 기록한다면 시간의 흐름에 따른 착각을 줄일수 있다.